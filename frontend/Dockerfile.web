# Build stage
FROM node:18-alpine as build

WORKDIR /app

# Copy package files and install dependencies
COPY package*.json ./

# Install dependencies with clean npm cache
RUN npm cache clean --force && \
    npm install

# Install specific version of Expo CLI globally
RUN npm install -g expo-cli@6.3.10

# Copy the rest of the application code
COPY . .

# Add web-specific configuration
RUN echo '{ "name": "Nutrition Tracker", "display": "standalone", "orientation": "portrait", "scope": "/", "start_url": "/", "icons": [{ "src": "/assets/icon.png", "type": "image/png", "sizes": "512x512" }] }' > web-manifest.json

# Create a custom build script that uses the correct command
RUN echo '#!/bin/sh\nset -e\necho "Building web app..."\nnpx expo export:web\n' > build-web.sh && \
    chmod +x build-web.sh

# Run the custom build script
RUN ./build-web.sh

# Production stage
FROM nginx:alpine

# Copy the built app to nginx
COPY --from=build /app/web-build /usr/share/nginx/html

# Copy nginx configuration for SPA routing
COPY --from=build /app/nginx.conf /etc/nginx/conf.d/default.conf

# Expose port 80
EXPOSE 80

# Start nginx
CMD ["nginx", "-g", "daemon off;"]